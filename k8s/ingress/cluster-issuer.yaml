# ClusterIssuer for automated TLS certificates via Let's Encrypt.
#
# cert-manager watches for Ingress resources annotated with
#   cert-manager.io/cluster-issuer: letsencrypt-prod
# and automatically:
#   1. Generates a private key and CSR
#   2. Creates an ACME order with Let's Encrypt
#   3. Solves the HTTP-01 challenge (proves domain ownership by serving a
#      token at http://<domain>/.well-known/acme-challenge/<token>)
#   4. Stores the signed certificate in a Kubernetes Secret
#   5. Renews it ~30 days before expiry
#
# The HTTP-01 solver uses the ingress controller: cert-manager creates a
# temporary Ingress that routes the challenge path to a solver pod.
# This is why the LB must be reachable on port 80 from the internet.

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Let's Encrypt production endpoint (rate limits: 50 certs/domain/week)
    server: https://acme-v02.api.letsencrypt.org/directory
    email: nicolas@sovereigncloudwisdom.eu
    # Secret where the ACME account private key is stored
    privateKeySecretRef:
      name: letsencrypt-prod-account-key
    solvers:
      - http01:
          ingress:
            ingressClassName: nginx
