# ClusterIssuer for automated TLS certificates via Let's Encrypt.
#
# cert-manager watches for Ingress resources annotated with
#   cert-manager.io/cluster-issuer: letsencrypt-prod
# and automatically:
#   1. Generates a private key and CSR
#   2. Creates an ACME order with Let's Encrypt
#   3. Solves the challenge (HTTP-01 or DNS-01 depending on domain)
#   4. Stores the signed certificate in a Kubernetes Secret
#   5. Renews it ~30 days before expiry
#
# Two solvers are configured:
#   - DNS-01 for the apex domain (sovereigncloudwisdom.eu): uses the
#     cert-manager-webhook-scaleway to create a TXT record via Scaleway DNS API.
#     This avoids the hairpin NAT + proxy protocol issue that breaks HTTP-01
#     for the apex domain on Scaleway (see memory/scaleway-ingress.md).
#   - HTTP-01 for subdomains (scw.sovereigncloudwisdom.eu): cert-manager creates
#     a temporary Ingress that routes the challenge path to a solver pod.

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Let's Encrypt production endpoint (rate limits: 50 certs/domain/week)
    server: https://acme-v02.api.letsencrypt.org/directory
    email: nicolas@sovereigncloudwisdom.eu
    # Secret where the ACME account private key is stored
    privateKeySecretRef:
      name: letsencrypt-prod-account-key
    solvers:
      # DNS-01 for the apex domain (HTTP-01 fails due to hairpin NAT)
      - selector:
          dnsNames:
            - sovereigncloudwisdom.eu
        dns01:
          webhook:
            groupName: acme.scaleway.com
            solverName: scaleway
            config:
              accessKeySecretRef:
                key: SCW_ACCESS_KEY
                name: scaleway-dns-credentials
              secretKeySecretRef:
                key: SCW_SECRET_KEY
                name: scaleway-dns-credentials
      # HTTP-01 for everything else (subdomains)
      - http01:
          ingress:
            ingressClassName: nginx
